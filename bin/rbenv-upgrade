#!/usr/bin/env bash
#
# rbenv-upgrade - upgrade subcommand for rbenv.
# Copyright (c) 2013 Koichi OKADA. All rights reserved.
# This script is distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php
#
# Summary: upgrade the rbenv and all plugins.
#
# Usage: rbenv upgrade [options]
#
#   -n/--dry-run     perform a trial run with no changes made
#

usage() {
  rbenv-help install 2>/dev/null || sed -ne '/^#/!q;s/.//;s/.//;1,4d;p' < "$0"
  [ -z "$1" ] || exit "$1"
}

# Provide rbenv completions
completion() {
  exit
}

while [ "$1" != "" ]; do
  case "$1" in
    --complete)
      completion
      shift
      ;;
    -h|--help)
      usage 0
      shift
      ;;
    -n|--dry-run)
      OPT_N=1
      shift
      ;;
    *)
      if getopts "" opt; then
        case "$opt" in
          ?) usage 1;;
        esac
        shift $(( $OPTIND - 1 ))
      else
        REMAINS+=("$1")
        shift
      fi
      ;;
  esac
done

if [ "$REMAINS" != "" ]; then
  usage 1
fi

ls -d1 ~/.rbenv ~/.rbenv/plugins/* | while read i; do
   echo -e "\e[32;1mUpgrade:\e[30;0m $i"
   if [ "$OPT_N" = "" ]; then
     echo "( cd $i; pwd; git pull )"
   fi
   echo
done
