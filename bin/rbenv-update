#!/usr/bin/env bash
#
# rbenv-update - update subcommand for rbenv.
#
# Copyright (c) 2013 Koichi OKADA. All rights reserved.
# This script is distributed under the MIT license.
# http://www.opensource.org/licenses/mit-license.php

usage() {
  {
    echo "Usage: rbenv update"
    echo
    echo "Update rbenv and all plugins using git."
  } >&2

  [ -z "$1" ] || exit "$1"
}

# Provide rbenv completions
completion() {
  exit
}

while [ "$1" != "" ]; do
  case "$1" in
    --complete)
      completion
      shift
      ;;
    -h|--help)
      usage 0
      shift
      ;;
    *)
      if getopts "" opt; then
        case "$opt" in
          ?) usage 1;;
        esac
        shift $(( $OPTIND - 1 ))
      else
        REMAINS+=("$1")
        shift
      fi
      ;;
  esac
done

if [ "$REMAINS" != "" ]; then
  usage 1
fi

for i in ~/.rbenv ~/.rbenv/plugins/*; do
  if [ -d "$i" ]; then
    cd "$i"
    if [ -d .git ]; then
      echo -e "\e[31;1mupdate using git:\e[0m `pwd`"
      git pull
    elif [ -d .bzr ]; then
      echo -e "\e[31;1mupdate using bzr:\e[0m `pwd`"
      bzr pull
    elif [ -d .hg ]; then
      echo -e "\e[31;1mupdate using hg:\e[0m `pwd`"
      hg pull
      hg update
    elif [ -d .svn ]; then
      echo -e "\e[31;1mupdate using svn:\e[0m `pwd`"
      svn update
    else
      echo -e "\e[31;1mupdate is not available:\e[0m `pwd`"
    fi
    echo
  fi
done
